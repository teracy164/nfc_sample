<html>
    <head>
        <script>
            const isEnabledNFC = () => {
                /*
                    参考：https://w3c.github.io/web-nfc/#feature-support
                */
                if ('NDEFReader' in window) {
                    return true;
                } else {
                    document.getElementById('notice').style.display = '';
                    return false;
                }
            }
            const log = (msg) => {
                const result = document.getElementById('result');
                result.innerHTML += '<BR>' + JSON.stringify(msg);
            }
            const readNFC = async () => {
                return new Promise(async (resolve, reject) => {
                    /*
                        参考：https://w3c.github.io/web-nfc/#feature-support
                    */
                    try {
                        log('start read NFC')
                        const reader = new NDEFReader();
                        /*
                            scan method
                            参考：https://w3c.github.io/web-nfc/#the-scan-method
                        */
                        await reader.scan();
                        log('scan start success.')
                        reader.onreading = event => {
                            log(`onreading. ${event}`)
                            console.log(event);
                            //resolve(event);
                        }
                        reader.onerror = event => {
                            log(`onerror. ${event}`);
                            console.error(event);
                            //reject(event);
                        }
                    } catch (err) {
                        log(`scan error. ${err}`)
                        console.error(err);
                        reject(JSON.stringify(err));
                    }
                });
            }
            const startNFC = () => {
                const btnArea = document.getElementById('btn-area');
                btnArea.setAttribute('disabled', true);
                readNFC().then(result => {
                    btnArea.setAttribute('disabled');
                }).catch(err => {
                    btnArea.removeAttribute('disabled');
                })
            };

            const abortNFC = () => {
                const controller = new AbortController();
                controller.abort();
                log('stop');
            }

            window.onload = () => {
                if (isEnabledNFC()) {
                    console.log('nfc supported.')
                    document.getElementById('btn').style.display='';
                } else {
                    console.log('nfc not supported.')
                    document.getElementById('btn').style.display='none';
                }                
            }
        </script>
    </head>
    <body>
        <div id="notice" style="display: none">
            以下にアクセスし、Enabledに設定してください<br>
            chrome://flags/#enable-experimental-web-platform-features
        </div>
        <div style="padding: 10px; text-align: center;" id="btn-area">
            <button onclick="startNFC()">start NFC</button>
            <button onclick="abortNFC()">abort</button>
        </div>
        <div id="result">

        </div>
    </body>
</html>
